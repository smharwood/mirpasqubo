\documentclass[11pt]{article}

\usepackage{amsmath,amssymb,xfrac}
\usepackage{algorithm,algorithmic}
\usepackage[margin=1in]{geometry}
\usepackage{url}

\usepackage{amsthm}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{corollary}{Corollary}
\newtheorem{assumption}{Assumption}
\theoremstyle{definition}
\newtheorem{definition}{Definition}

\newcommand{\card}[1]{\left| #1 \right|}

\newcommand{\mbf}{\mathbf}
\newcommand{\mbb}{\mathbb}
\newcommand{\mbs}{\boldsymbol}
\newcommand{\st}{\mathrm{s.t.}\;}
\newcommand{\tr}{^{\mathrm{T}}}
\newcommand{\abs}[1]{\left| #1 \right|}
\newcommand{\norm}[1]{\left\| #1 \right\|}
\newcommand{\set}[1]{\left\{ #1 \right\}}
\newcommand{\grad}{\nabla}
\newcommand{\smallsum}{{\textstyle{\sum}}}
\newcommand{\symgt}{\succ}
\newcommand{\symge}{\succeq}
\renewcommand{\hat}{\widehat}
\renewcommand{\tilde}{\widetilde}

\newcommand{\0}{\mathbf{0}}
\renewcommand{\a}{\mathbf{a}}
\renewcommand{\b}{\mathbf{b}}
\renewcommand{\c}{\mathbf{c}}
\renewcommand{\d}{\mathbf{d}}
\newcommand{\g}{\mathbf{g}}
\newcommand{\q}{\mathbf{q}}
\renewcommand{\r}{\mathbf{r}}
\newcommand{\s}{\mathbf{s}}
\renewcommand{\u}{\mathbf{u}}
\renewcommand{\v}{\mathbf{v}}
\newcommand{\w}{\mathbf{w}}
\newcommand{\x}{\mathbf{x}}
\newcommand{\y}{\mathbf{y}}
\newcommand{\z}{\mathbf{z}}

\title{Arc-based formulation of MIRP}
%\author{Stuart M. Harwood \and Dimitar Trenev}
\date{\today}

\begin{document}
\maketitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Formulation}

Our problem is a vehicle routing problem with time windows (VRPTW).
We use a discrete-time arc-based formulation to obtain a math program.
The setting is a graph with nodes $N \cup \set{d}$ and edges $E$.
Edges $(i,j) \in E$ have a cost $c_{i,j}$ and time of travel $t_{i,j}$.
A set of discrete time points $T$ is available.
All nodes $i \in N$ have the same level of demand.
Nodes have a time window $W_i = [a_i,b_i]$ enclosing at least one time point in $T$: $T \cap [a_i,b_i] \neq \emptyset$.
A (potentially infinite?) fleet of vehicles is available.
Each vehicle starts from the depot $d$.

The variables of the math program are
\begin{itemize}
\item $x_{i,s,j,t} \in \set{0,1}$ : A vehicle travels from node $i$ at time $s$ to node $j$ at time $t$ ($1$) or not ($0$).
\end{itemize}


The formulation to minimize cost of travel while meeting each node's time window is
\begin{align}
\min_x\; & \sum_{i,s,j,t} c_{i,j} x_{i,s,j,t} \\
\st
&\label{con:1}  \sum_{j,t} x_{j,t,i,s} = \sum_{j,t} x_{i,s,j,t}, \quad \forall (i,s) \in N \times T \\
&\label{con:2}  \sum_{i,s,t} x_{i,s,j,t} = 1, \quad \forall j \in N, \\
&\label{con:31} x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): t \notin [a_j,b_j], \\
&\label{con:32} x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): s \notin [a_i,b_i], \\
&\label{con:4}  x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): (i,j) \notin E, \\
&\label{con:5}  x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): s + t_{i,j} > t, \\
&               x_{i,s,j,t} \in \set{0,1}, \quad \forall (i,s,j,t)
\end{align}

Constraint~\eqref{con:1} ensures flow conservation (if a vehicle enters a node $i$ at time $s$, it must leave that node at that time).
Note that we do not care about this holding for the depot $d$, otherwise the vehicles could not get started.
Constraint~\eqref{con:2} ensures that each node (besides the depot $d$) is visited exactly once over all vehicles.
Constraint~\eqref{con:31} ensures that a vehicle servicing a node arrives during its time window.
Constraint~\eqref{con:32} is implied by \eqref{con:1} and \eqref{con:2}, but explicitly, if a node has been serviced, the vehicle must ``leave immediately.''
Constraint~\eqref{con:4} ensures that vehicles obey the allowed travel arcs.
Constraint~\eqref{con:5} ensures that vehicles do not travel back in time.
Note that we do not enforce the timing ``exactly'' (i.e. we allow $x_{i,s,j,t}$ with $s + t_{i,j}$ strictly less than $t$);
this permits the possibly that a vehicle arrives early and waits.

A constraint on the number of vehicles available can be enforced by making sure that the number of outgoing arcs from the depot $d$ equals the number of available vehicles.
With Constraint~\eqref{con:1}, this ensures that vehicles can be used at most once.
If necessary, the only nodes directly connected to the depot can be thought of as ``dummy'' nodes, and essentially keep track of whether a vehicle is used or not.

We will derive an equivalent quadratic unconstrained binary optimization (QUBO) problem.


\section{QUBO reformulation}
Expressing the linear equality constraints of the formulation above as $Ax = b$, an exact penalty reformulation is 
\begin{equation}
\label{qubo}
\begin{aligned}
\min_x\; &\sum_{i,s,j,t} c_{i,j} x_{i,s,j,t} + \rho\norm{Ax - b}^2 \\
\st 
&x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): t \notin [a_j,b_j], \\
&x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): s \notin [a_i,b_i], \\
&x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): (i,j) \notin E, \\
&x_{i,s,j,t} = 0, \quad \forall (i,s,j,t): s + t_{i,j} > t, \\
&x_{i,s,j,t} \in \set{0,1}, \quad \forall (i,s,j,t)
\end{aligned}
\end{equation}
For penalty parameter $\rho$ sufficiently large, the solutions of the two math programs coincide.
Looking at the specifics of the constraints and considering that the variables are binary, the smallest value that the penalty terms can take for an infeasible solution is $\rho$ ($=\rho\cdot 1$).
Thus, $\rho$ needs to be big enough to overwhelm any decrease in the original objective by moving to an infeasible point.
Imagine flipping each variable from $0$ to $1$ or vice versa depending on the sign of $c_{i,j}$;
we can upper bound that change in objective by
$\sum_{i,s,j,t} \abs{c_{i,j}} = \card{T}^2 \sum_{(i,j) \in E} \abs{c_{i,j}}$.
Thus 
\[
\rho > \card{T}^2 \sum_{(i,j) \in E} \abs{c_{i,j}}
\]
suffices.
%
The term $\norm{Ax - b}^2$ expands to $x\tr A\tr A x - 2 b\tr Ax + b\tr b$.
We can add the other linear terms from the objective to get an objective in the form $x\tr Q x$, as desired for a QUBO.


\section{MIRP considerations}
Similar to the path-based formulation, ship (vehicle) capacity determines the demand levels and time windows of the nodes.
The assumption that the nodes have the same demand level is not restrictive;
this follows when we assume homogeneous ships and full unload/load as in the path-based formulation.
Further, we enforce an alternating sequence of supply and demand nodes by pruning out all other edges.
Vehicle starting positions are enforced through dummy nodes and appropriate edges.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliographystyle{plain}
%\input{./bib/BibList.tex}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
